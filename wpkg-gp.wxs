<?xml version='1.0' encoding='Windows-1252'?>
<Wix xmlns='http://schemas.microsoft.com/wix/2006/wi'>
<!--
The following variables need to be set in :
ReleaseVersion: The version of WPKG-GP in x.y format, eg 0.6
BuildArch:      The Architecture we are building for, x86 or x64
-->

  <?if $(sys.BUILDARCH) = "x64" ?>
    <?define var.PlatformInstallDir="InstallDirx64" ?>
  <?else ?>
    <?define var.PlatformInstallDir="InstallDir" ?>    
  <?endif ?>
  
  <!--
  Keep track of old ID's here:
  0.5: {A70E99ED-87C6-4142-88A7-8491459494A2} {}'s added by an error, make sure to keep
  0.6: 1f97d86c-2968-4def-9419-9d9cb349c339
  0.7: f4fefaeb-9305-42dd-a6a6-dcdf0664a642
  
  -->
  <Product Name='WPKG-gp $(var.ReleaseVersion)' Id='f4fefaeb-9305-42dd-a6a6-dcdf0664a642'
           UpgradeCode='5d49d975-2f3e-4a47-97f5-3cb759de60b1'
           Language='1033' Codepage='1252' Version='$(var.ReleaseVersion).0'
           Manufacturer='The WPKG-gp team'>

    <Package Id='*' Keywords='Installer' Description="WPKG-gp $(var.ReleaseVersion) Installer"
             Comments='http://code.google.com/p/wpkg-gp/'
             Manufacturer='The WPKG-gp team'
             InstallerVersion='300' Languages='1033' Compressed='yes'
             SummaryCodepage='1252' Platform='$(sys.BUILDARCH)' />
    
    <Upgrade Id='5d49d975-2f3e-4a47-97f5-3cb759de60b1'>
      <UpgradeVersion OnlyDetect='no' Property='PREVIOUSFOUND'
                      Minimum='0.1.0' IncludeMinimum='yes'
                      Maximum='$(var.ReleaseVersion).0' IncludeMaximum='no' />
    </Upgrade>

    <InstallExecuteSequence>
      <RemoveExistingProducts Before="InstallInitialize"/>
    </InstallExecuteSequence>

    <Condition Message="You need to be an administrator to install this product.">
      Privileged
    </Condition>
    
	<!-- VS2010 does not support Windows 2000 or XP =< SP1 anymore -->
    <Condition Message='You need a Windows version >= Windows XP SP2 to install this product.'>
      <![CDATA[  VersionNT >= 600 OR (VersionNT >= 501 AND ServicePackLevel >= 2) ]]>
    </Condition>
    
    <Media Id='1' Cabinet='wpkg_gp.cab' EmbedCab='yes' DiskPrompt='CD-ROM #1' />
    <Property Id='DiskPrompt' Value="WPKG-gp Installation [1]" />

    <Directory Id='TARGETDIR' Name='SourceDir'>
	  <!-- ADM template -->
      <Directory Id='WindowsFolder' Name='Windows'>
        <Directory Id='Inf' Name='Inf'>
          <Component Id='ADMComponent' Guid='60d976f1-9b3e-4a25-a4fb-5af91ad7e7bb'>
            <File Id='ADMFile' DiskId='1' Name='wpkg-gp.adm' Source='src\wpkg-gp.adm' KeyPath='yes' />
          </Component>
        </Directory>
      </Directory>
	  <Directory Id='ProgramFilesFolder' Name="ProgramFiles">
		<Directory Id='InstallDir' Name='WPKG-gp'>
		  <Directory Id="WPKGClientVC90Redist" Name='Microsoft.VC90.CRT'>
		    <Component Id='WpkgClientVC90RedistComponent' Guid='98076711-ed3e-4b5e-95e2-6a2c09084782'>
				<File Id='WPKGClientVC90Libmsvcp90' DiskId='1' Name='msvcp90.dll' Source='redist\VC90\Microsoft.VC90.CRT\msvcp90.dll' />
				<File Id='WPKGClientVC90Libmsvcr90' DiskId='1' Name='msvcr90.dll' Source='redist\VC90\Microsoft.VC90.CRT\msvcr90.dll' />
				<File Id='WPKGClientVC90Libmsvcm90' DiskId='1' Name='msvcm90.dll' Source='redist\VC90\Microsoft.VC90.CRT\msvcm90.dll' />
				<File Id='WPKGClientVC90LibManifest' DiskId='1' Name='Microsoft.VC90.CRT.manifest' Source='redist\VC90\Microsoft.VC90.CRT\Microsoft.VC90.CRT.manifest' />
			</Component>
			</Directory>
		  <Component Id="WPKGClient" Guid="b26d4e48-43ae-4944-bc12-39c16375f89b">   
			<File Id='PythonLib_Win32SysLoader' DiskId='1' Name='_win32sysloader.pyd' Source='dist\_win32sysloader.pyd' />
			<File Id='PythonLibBz2'             DiskId='1' Name='bz2.pyd' Source='dist\bz2.pyd' />
			<File Id='PythonLibLibrary'         DiskId='1' Name='library.zip' Source='dist\library.zip' />
			<File Id='PythonLibPerfMon'         DiskId='1' Name='perfmon.pyd' Source='dist\perfmon.pyd' />
			<File Id='Python26Dll'              DiskId='1' Name='python26.dll' Source='dist\python26.dll' />
			<File Id='PyWinTypes26Dll'          DiskId='1' Name='pywintypes26.dll' Source='dist\pywintypes26.dll' />
			<File Id='PythonLibSelect'          DiskId='1' Name='select.pyd' Source='dist\select.pyd' />
			<File Id='PythonLibServiceManager'  DiskId='1' Name='servicemanager.pyd' Source='dist\servicemanager.pyd'/>
			<File Id='PythonLibUnicodeData'     DiskId='1' Name='unicodedata.pyd' Source='dist\unicodedata.pyd' />
			<File Id='W9xPopen'                 DiskId='1' Name='w9xpopen.exe' Source='dist\w9xpopen.exe' />
			<File Id='PythonLibWin32API'        DiskId='1' Name='win32api.pyd' Source='dist\win32api.pyd' />
			<File Id='PythonLibWin32Event'      DiskId='1' Name='win32event.pyd' Source='dist\win32event.pyd' />
			<File Id='PythonLibWin32EvtLog'     DiskId='1' Name='win32evtlog.pyd' Source='dist\win32evtlog.pyd' />
			<File Id='PythonLibWin32File'       DiskId='1' Name='win32file.pyd' Source='dist\win32file.pyd' />
			<File Id='PythonLibWin32Pipe'       DiskId='1' Name='win32pipe.pyd' Source='dist\win32pipe.pyd' />
			<File Id='PythonLibWin32Security'   DiskId='1' Name='win32security.pyd' Source='dist\win32security.pyd' />
			<File Id='PythonLibWin32Client'     DiskId='1' Name='win32service.pyd' Source='dist\win32service.pyd' />
			<File Id='WPKGClientWpkgPipeClient' DiskId='1' Name='WpkgPipeClient.exe' Source='dist\WpkgPipeClient.exe' />
		  </Component>
		  <Component Id='WPKGService' Guid='f86f943e-bd60-45aa-a425-e42f1a49ca1b'>
		    <File Id='WpkgServerExe' DiskId='1' Name='WpkgServer.exe' Source='dist\WpkgServer.exe' KeyPath='yes' />
	        <ServiceInstall Id='WPKGServiceInstall' Name='WpkgServer' DisplayName='WPKG Control Service'
							Description='Controller service for userspace WPKG management applications. (http://wpkg-gp.googlecode.com/)'
							ErrorControl='normal' Start='auto' Type='ownProcess' />
			<ServiceControl Id='WPKGServiceControl' Name='WpkgServer'
                            Remove='uninstall' Start='install' Stop='both' Wait='yes' />
	      </Component>
		  <Component Id='RegisterSoftwareSettings' Guid='51afb602-1e39-4fe0-a1e4-3695a6f061b1'>
		    <?if $(sys.BUILDARCH) = "x64" ?>
			<RegistryKey Id='SoftwareSettingsKey' Root='HKLM' Key='SOFTWARE\Wow6432Node\WPKG-gp' Action='createAndRemoveOnUninstall'>
			  <RegistryValue Id='RegisterInstallPath'
                             Name='InstallPath' Action='write' Type='string' Value='[InstallDir]' />
	        </RegistryKey>
			<?else ?>
			<RegistryKey Id='SoftwareSettingsKey' Root='HKLM' Key='SOFTWARE\WPKG-gp' Action='createAndRemoveOnUninstall'>
			  <RegistryValue Id='RegisterInstallPath'
                             Name='InstallPath' Action='write' Type='string' Value='[InstallDir]' />
	        </RegistryKey>
			<?endif ?>
          </Component>
		</Directory>
	  <!-- WPKG-gp.dll and WPKG-gp-test.exe should go into platform specific program files dir. Make a reference here -->
	  <?if $(sys.BUILDARCH) = "x64" ?>
	  <Directory Id='ProgramFiles64Folder' Name='ProgramFilesx64'>
	    <Directory Id="InstallDirx64" Name="WPKG-gp" />
	  </Directory>
	  <?endif ?>
	  </Directory>
    </Directory>
	
	<DirectoryRef Id="$(var.PlatformInstallDir)">
        <Component Id='GPExtention' Guid='9a9ffe56-fe95-48a6-b19d-d7f386c65456'>
        <!-- GPO Extention and registering -->
        <File Id='GPEDll' DiskId='1' Name='WPKG-gp.dll' Source='src\gpe\$(sys.BUILDARCH)\Release\WPKG-gp.dll' KeyPath='yes' />
		<!-- Registering as a GPE -->
        <RegistryKey Id='RegisterGPEDllKey' Root='HKLM'
                     Key='SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\GPExtensions\{A9B8D792-F454-11DE-BA92-FDCF56D89593}'
                     Action='createAndRemoveOnUninstall' >
          <RegistryValue Id='RegisterGPEDllDefaultValue'
                         Action='write' Type='string' Value='WPKG-gp' />
          <RegistryValue Id='RegisterGPEDllName'
                         Name='DllName' Action='write' Type='multiString' Value='[$(var.PlatformInstallDir)]WPKG-gp.dll' />
          <RegistryValue Id='RegisterGPEDllNoBackgroundPolicy'
                         Name='NoBackgroundPolicy' Action='write' Type='integer' Value='1' />
          <RegistryValue Id='RegisterGPEDllNoUserPolicy'
                         Name='NoUserPolicy' Action='write' Type='integer' Value='1' />
          <RegistryValue Id='RegisterGPEDllProcessGroupPolicy'
                         Name='ProcessGroupPolicy' Action='write' Type='string' Value='ProcessGroupPolicy' />
        </RegistryKey>
		<RegistryKey Id="RegisterGpLoggingKey" Root="HKLM"
		             Key='System\CurrentControlSet\Services\EventLog\Application\WPKG-gp-GPE'
					 Action='createAndRemoveOnUninstall' >
		  <RegistryValue Id='GpLoggingKeyEventMessageFile'
		                 Name='EventMessageFile' Action='write' Type='string' Value='[InstallDir]WPKG-gp.dll' />
		  <RegistryValue Id='GpLoggingKeyTypesSupported'
		                 Name='TypesSupported' Action='write' Type='integer' Value='7' />
		</RegistryKey>
      </Component>
	  <Component Id='GPTestTool' Guid='63603cb0-f599-4dae-b24e-723545c673cc'>
        <File Id='GPTestExe' DiskId='1' Name='WPKG-GP-Client.exe' Source='src\gpe\$(sys.BUILDARCH)\Release\WPKG-gp-test.exe' KeyPath='yes' />
      </Component>
	</DirectoryRef>
	
	<!-- Including VCPP2010 Runtime Library -->
    <DirectoryRef Id="$(var.PlatformInstallDir)">
      <Directory Id="VCPP2010RedistDirectory" Name="VC++2010Redist">
        <Component Id="VCPP2010Redist" Guid="98789b31-4b23-4ef4-b267-b87cf2e8f662">
		  <File Id="VCPP2010RedistExe" Source="redist\VC100\vcredist_$(sys.BUILDARCH).exe" KeyPath="yes" Checksum="yes"/>
        </Component>
      </Directory>
    </DirectoryRef>
    
    
    <Feature Id='Complete' Title='WPKG-gp $(var.ReleaseVersion)' Level='1' Description='Complete installation'
             Display='expand'>
      <Feature Id='GPExtentionFeature' Title='Group Policy Extention and service' Description='Install and register the Group Policy Extention DLL. This action installs the needed C++ Merge module as well.' Level='1'>
	    <ComponentRef Id='RegisterSoftwareSettings' />
        <ComponentRef Id='GPExtention' />
		<ComponentRef Id='WPKGClient' />
		<ComponentRef Id='WPKGService' />
        <ComponentRef Id='VCPP2010Redist' />
		<ComponentRef Id='WpkgClientVC90RedistComponent' />
      </Feature>
      <Feature Id='ADMComponentFeature' Title='Administrative Template' Description='Install the Administrative Template for configuring the WPKG-gp GPE' Level='1'>
        <ComponentRef Id='ADMComponent'/>
      </Feature>
      <Feature Id='WPKGGPClientFeature' Level='1' Title='Debug Tool' Description='Install a debugging tool that does the same as the wpkg-gp.dll'>
	    <ComponentRef Id='RegisterSoftwareSettings' />
        <ComponentRef Id='GPTestTool' />
		<ComponentRef Id='WPKGClient' />
		<ComponentRef Id='WPKGService' />
        <ComponentRef Id='VCPP2010Redist' />
		<ComponentRef Id='WpkgClientVC90RedistComponent' />
      </Feature>
    </Feature>
	
	<!-- Check to see if Visual C++ Redist 2010 is installed -->
    <Property Id='VCPP2010ISINSTALLED'>
	  <?if $(sys.BUILDARCH) = "x64" ?>
      <RegistrySearch Id='VCPP2010IsInstalledRegSearch' Root='HKLM'
                      Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{DA5E371C-6333-3D8A-93A4-6FD5B20BCC6E}'
                      Type='raw' Name='DisplayVersion'/>
	  <?else ?>
	  <RegistrySearch Id='VCPP2010IsInstalledRegSearch' Root='HKLM'
                      Key='SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall\{196BB40D-1578-3D01-B289-BEFC77A11A1E}'
                      Type='raw' Name='DisplayVersion'/>
	  <?endif ?>
    </Property>

    <CustomAction Id="InstallVCPP2010" FileKey="VCPP2010RedistExe"
                  ExeCommand="/passive" Execute="deferred"
                  Impersonate="no" Return="asyncNoWait" />
    
    <CustomAction Id="InstallVCPP2010Silent" FileKey="VCPP2010RedistExe"
                  ExeCommand="/q" Execute="deferred"
                  Impersonate="no" Return="asyncNoWait" />

    <InstallExecuteSequence>
      <!-- <RemoveExistingProducts After="InstallInitialize">
	    <![CDATA[OLDERVERSIONBEINGUPGRADED]]>
	  </RemoveExistingProducts> -->
      <Custom Action="InstallVCPP2010" After="InstallFiles">
        <!-- Execute only if component is selected for installation, and UILevel = 2 and skip if already installed -->
        <![CDATA[ ($VCPP2010Redist > 1) AND (UILevel > 2) AND NOT VCPP2010ISINSTALLED]]>
      </Custom>
      <Custom Action="InstallVCPP2010Silent" After="InstallFiles">
        <!-- Execute only if component is selected for installation, and UILevel = 2 and skip if already installed -->
        <![CDATA[ ($VCPP2010Redist > 1) AND (UILevel = 2) AND NOT VCPP2010ISINSTALLED]]>
      </Custom>
    </InstallExecuteSequence>
    
    <UIRef Id="WixUI_Mondo" />
    <UI>
      <ProgressText Action="InstallVCPP2010">Launching Visual C++ 2010 Redistributable installer</ProgressText>
    </UI>
    <WixVariable Id="WixUILicenseRtf" Value="installer\License.rtf" />

  </Product>
</Wix>